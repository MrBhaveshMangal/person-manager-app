<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Person Manager</title>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <style>
        * {
          box-sizing: border-box;
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
          background: #f5f7fa;
          margin: 0;
          padding: 0;
        }

        .header {
          background-color: #333;
          color: #fff;
          padding: 15px 20px;
          display: flex;
          justify-content: space-between;
          align-items: center;
          flex-wrap: wrap;
          gap: 10px;
        }

        .header .username {
          font-size: 15px;
          word-break: break-word;
        }

        .header button {
          background: #f44336;
          color: white;
          border: none;
          padding: 8px 16px;
          border-radius: 5px;
          cursor: pointer;
          min-height: 36px;
        }

        .container {
          max-width: 900px;
          margin: 20px auto;
          background: white;
          padding: 30px;
          border-radius: 12px;
          box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }

        h2 {
          text-align: center;
          margin-bottom: 25px;
          color: #333;
          font-size: 22px;
        }

        form {
          display: grid;
          grid-template-columns: 1fr 1fr 1fr auto;
          gap: 10px;
          align-items: end;
        }

        form input {
          padding: 12px;
          border: 1px solid #ccc;
          border-radius: 6px;
          font-size: 16px;
        }

        form button {
          padding: 12px 16px;
          background-color: #4CAF50;
          color: white;
          border: none;
          border-radius: 6px;
          font-size: 15px;
          cursor: pointer;
          min-height: 44px;
        }

        form button:disabled {
          background-color: #bbb;
          cursor: not-allowed;
        }

        .notification {
          grid-column: 1 / -1;
          margin-top: 10px;
          padding: 10px;
          border-radius: 5px;
          display: none;
          text-align: center;
          font-size: 14px;
        }

        .notification.show {
          display: block;
        }

        table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 25px;
        }

        table, th, td {
          border: 1px solid #ccc;
        }

        th, td {
          padding: 10px;
          text-align: left;
          font-size: 14px;
          word-break: break-word;
        }

        td button {
          font-size: 13px;
          padding: 6px 10px;
          margin-right: 5px;
          border-radius: 5px;
          border: none;
          cursor: pointer;
          min-height: 36px;
        }

        td button.edit {
          background-color: #4CAF50;
          color: white;
        }

        td button.delete {
          background-color: #f44336;
          color: white;
        }

        .loader {
          border: 3px solid rgba(255,255,255,0.4);
          border-top: 3px solid white;
          border-radius: 50%;
          width: 16px;
          height: 16px;
          animation: spin 1s linear infinite;
        }

        @keyframes spin {
          to { transform: rotate(360deg); }
        }

        button.loading {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
          pointer-events: none;
        }

        @media (max-width: 768px) {
          .container {
            margin: 15px;
            padding: 20px;
          }

          form {
            grid-template-columns: 1fr;
          }

          table thead {
            display: none;
          }

          table tr {
            display: block;
            margin-bottom: 15px;
          }

          table td {
            display: block;
            border: none;
            border-bottom: 1px solid #eee;
          }

          table td:last-child {
            border-bottom: none;
          }
        }
    </style>
</head>

<body>

<div class="header">
    <div class="username" id="usernameDisplay">ðŸ‘¤</div>
    <button onclick="logout()">Logout</button>
</div>

<div class="container">
    <h2>Person Manager</h2>

    <form id="personForm">
        <input id="name" placeholder="Name">
        <input id="email" placeholder="Email">
        <input id="dob" placeholder="Date of Birth">
        <button type="submit" id="saveBtn">Save</button>
        <div id="notification" class="notification"></div>
    </form>

    <table id="personTable">
        <thead>
        <tr>
            <th>Name</th>
            <th>Email</th>
            <th>DOB</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
    const authHeader = localStorage.getItem('basicAuth');
    const userName = localStorage.getItem('username');

    if (!authHeader) window.location.href = '/login.html';

    const axiosInstance = axios.create({
      headers: { Authorization: 'Basic ' + authHeader }
    });

    if (userName) {
      document.getElementById('usernameDisplay').textContent = 'ðŸ‘¤ ' + userName;
    }

    const form = document.getElementById('personForm');
    const tableBody = document.querySelector('#personTable tbody');
    const saveBtn = document.getElementById('saveBtn');
    const notification = document.getElementById('notification');
    let editId = null;

    flatpickr("#dob", {
      dateFormat: "Y-m-d",
      maxDate: "today",
      allowInput: false
    });

    function showMessage(msg, error) {
      notification.textContent = msg;
      notification.style.background = error ? '#f2dede' : '#dff0d8';
      notification.style.color = error ? '#a94442' : '#3c763d';
      notification.classList.add('show');
      setTimeout(() => notification.classList.remove('show'), 3000);
    }

    async function loadPersons() {
      try {
        const res = await axiosInstance.get('/person/get');
        tableBody.innerHTML = '';
        res.data.forEach(p => {
          tableBody.innerHTML += `
            <tr>
              <td>${p.name}</td>
              <td>${p.email}</td>
              <td>${p.dateOfBirth}</td>
              <td>
                <button class="edit" onclick="editPerson('${p.id}','${p.name}','${p.email}','${p.dateOfBirth}')">Edit</button>
                <button class="delete" onclick="deletePerson('${p.id}', this)">Delete</button>
              </td>
            </tr>
          `;
        });
      } catch {
        showMessage('Failed to load data', true);
      }
    }

    function editPerson(id, name, email, dob) {
      editId = id;
      document.getElementById('name').value = name;
      document.getElementById('email').value = email;
      document.getElementById('dob').value = dob;
    }

    async function deletePerson(id, btn) {
      btn.classList.add('loading');
      btn.innerHTML = `<div class="loader"></div>`;
      try {
        await axiosInstance.delete('/person/delete/' + id);
        showMessage('Person deleted successfully', false);
        loadPersons();
      } catch {
        showMessage('Delete failed', true);
      }
    }

    async function savePerson() {
      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const dob = document.getElementById('dob').value.trim();

      if (!dob) {
        showMessage('Date of Birth is required', true);
        return;
      }

      const payload = { name, email, dateOfBirth: dob };

      saveBtn.classList.add('loading');
      saveBtn.innerHTML = `<div class="loader"></div> Saving...`;
      saveBtn.disabled = true;

      try {
        if (editId) {
          await axiosInstance.put('/person/update/' + editId, payload);
          editId = null;
          showMessage('Person updated successfully', false);
        } else {
          await axiosInstance.post('/person/add', payload);
          showMessage('Person added successfully', false);
        }

        form.reset();
        loadPersons();
      } catch (err) {
        const msg = err.response?.data?.message || err.response?.data?.error || 'Save failed';
        showMessage(msg, true);
      } finally {
        saveBtn.classList.remove('loading');
        saveBtn.innerHTML = 'Save';
        saveBtn.disabled = false;
      }
    }

    form.addEventListener('submit', e => {
      e.preventDefault();
      savePerson();
    });

    function logout() {
      localStorage.clear();
      window.location.href = '/login.html';
    }

    loadPersons();
</script>

</body>
</html>
