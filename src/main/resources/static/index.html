<script>
    const authHeader = localStorage.getItem('basicAuth');

    if (!authHeader) {
        window.location.href = '/login.html';
    }

    const axiosInstance = axios.create({
        baseURL: '',
        headers: { Authorization: 'Basic ' + authHeader }
    });

    const personTable = document.getElementById('personTable');
    const form = document.getElementById('personForm');
    let editId = null;

    async function loadPersons() {
        try {
            const res = await axiosInstance.get('/person/get');
            personTable.innerHTML = '';
            res.data.forEach(p => {
                personTable.innerHTML += `
                    <tr>
                      <td>${p.name}</td>
                      <td>${p.email}</td>
                      <td>${p.dateOfBirth}</td>
                      <td>
                        <button onclick="editPerson('${p.id}', '${p.name}', '${p.email}', '${p.dateOfBirth}')">Edit</button>
                        <button onclick="deletePerson('${p.id}')">Delete</button>
                      </td>
                    </tr>
                `;
            });
        } catch (error) {
            if (error.response && error.response.status === 401) {
                localStorage.clear();
                window.location.href = '/login.html';
            } else {
                alert('Error loading persons');
            }
        }
    }

    async function deletePerson(id) {
        if (confirm('Delete this person?')) {
            await axiosInstance.delete('/person/delete/' + id);
            showNotification('Person deleted successfully 🗑️');
            loadPersons();
        }
    }

    function editPerson(id, name, email, dob) {
        editId = id;
        document.getElementById('name').value = name;
        document.getElementById('email').value = email;
        document.getElementById('dob').value = dob;
    }

    async function savePerson() {
        const data = {
            name: document.getElementById('name').value,
            email: document.getElementById('email').value,
            dateOfBirth: document.getElementById('dob').value
        };
        try {
            if (editId) {
                await axiosInstance.put('/person/update/' + editId, data);
                showNotification('Person updated successfully 🎉');
                editId = null;
            } else {
                await axiosInstance.post('/person/add', data);
                showNotification('Person added successfully ✅');
            }
            form.reset();
            loadPersons();
        } catch (error) {
            alert('Error: ' + (error.response?.data || error.message));
        }
    }

    form.addEventListener('submit', e => {
        e.preventDefault();
        savePerson();
    });

    function showNotification(message) {
        const notif = document.getElementById('notification');
        notif.textContent = message;
        notif.classList.add('show');
        setTimeout(() => notif.classList.remove('show'), 2500);
    }

    loadPersons();
</script>
